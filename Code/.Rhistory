par(mar=c(1,1,1,1))
plot(coda::mcmc(delta_j_draws))
summary(coda::mcmc(delta_j_draws))
i <- 100
j_i <- stan_data$id[i]
delta_j_draws <- post_delta[, j_i, ]  # matrix: iterations x Kz
dim(delta_j_draws)
summary(coda::mcmc(delta_j_draws))
plot(coda::mcmc(delta_j_draws))
z_n <- stan_data$Z[i, ]             # vector of length Kz
theta_n_draws <- post_delta[, j_i, ] %*% z_n  # iterations x 1
plot(density(theta_n_draws),
main = paste0("Posterior of theta for obs ", n),
xlab = "theta_n")
summary(coda::mcmc(theta_n_draws))
i <- 670
j_i <- stan_data$id[i]
delta_j_draws <- post_delta[, j_i, ]  # matrix: iterations x Kz
dim(delta_j_draws)
summary(coda::mcmc(delta_j_draws))
plot(coda::mcmc(delta_j_draws))
z_n <- stan_data$Z[i, ]             # vector of length Kz
theta_n_draws <- post_delta[, j_i, ] %*% z_n  # iterations x 1
plot(density(theta_n_draws),
main = paste0("Posterior of theta for obs ", n),
xlab = "theta_n")
summary(coda::mcmc(theta_n_draws))
z_n
j_i
rstan::stan_trace(fit, pars = "Sigma_delta")
##### Nice plots of tau (treatment effects) #####
library(dplyr)
library(purrr)
library(ggplot2)
post_delta <- rstan::extract(fit, pars = "delta")$delta  # iter x J x Kz
# pick 10 students (change these indices as you like)
idx <- c(10, 25, 50, 75, 100, 250, 400, 670, 900, 1200)
# build draws of tau_ij = theta_n for each selected student
draws_df <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- stan_data$Z[i, ]                      # length Kz
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)  # iter-length vector
tibble(
student = factor(i, levels = idx),
tau = tau_draws
)
})
# per-student mean and 95% equal-tail CI
sum_df <- draws_df %>%
group_by(student) %>%
summarise(
mean = mean(tau),
lo   = quantile(tau, 0.025),
hi   = quantile(tau, 0.975),
.groups = "drop"
)
# density peaks (for drawing vertical lines up to the density height)
dens_df <- draws_df %>%
group_by(student) %>%
do({
d <- density(.$tau)
tibble(x = d$x, y = d$y)
}) %>%
ungroup()
peak_df <- dens_df %>%
group_by(student) %>%
summarise(ymax = max(y), .groups = "drop") %>%
left_join(sum_df, by = "student")
# plot: 5 x 2 panels
ggplot(draws_df, aes(x = tau)) +
geom_density() +
geom_vline(data = sum_df, aes(xintercept = mean), linewidth = 0.9) +
geom_vline(data = sum_df, aes(xintercept = lo), linetype = "dashed", linewidth = 0.8) +
geom_vline(data = sum_df, aes(xintercept = hi), linetype = "dashed", linewidth = 0.8) +
facet_wrap(~ student, ncol = 2) +
labs(
title = expression("Posterior distributions of " * tau[ij] * " for 10 students"),
x = expression(tau[ij]),
y = "Density"
) +
theme_minimal()
library(dplyr)
library(purrr)
library(ggplot2)
post_delta <- rstan::extract(fit, pars = "delta")$delta  # iter x J x Kz
# choose 10 students (change these indices)
idx <- c(10, 25, 50, 75, 100, 250, 400, 670, 900, 1200)
# posterior draws of tau_ij (theta) for each selected student
draws_df <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- stan_data$Z[i, ]                          # length Kz
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
student = factor(paste0("i = ", i), levels = paste0("i = ", idx)),
tau = tau_draws
)
})
# mean + 95% equal-tail CI
sum_df <- draws_df %>%
group_by(student) %>%
summarise(
mean = mean(tau),
lo   = quantile(tau, 0.025),
hi   = quantile(tau, 0.975),
.groups = "drop"
)
# histogram + vlines, 5x2 panels
ggplot(draws_df, aes(x = tau)) +
geom_histogram(
bins = 40,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(data = sum_df, aes(xintercept = mean, linetype = "Mean"),
linewidth = 1.0, color = "black") +
geom_vline(data = sum_df, aes(xintercept = lo, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
geom_vline(data = sum_df, aes(xintercept = hi, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
facet_wrap(~ student, ncol = 2, scales = "free_y") +
scale_linetype_manual(values = c("95% CI" = "dashed", "Mean" = "solid")) +
labs(x = expression(tau[ij]), y = "Count", linetype = "") +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
panel.grid = element_blank()
)
# histogram + vlines, 5x2 panels
ggplot(draws_df, aes(x = tau)) +
geom_histogram(
bins = 60,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(data = sum_df, aes(xintercept = mean, linetype = "Mean"),
linewidth = 1.0, color = "black") +
geom_vline(data = sum_df, aes(xintercept = lo, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
geom_vline(data = sum_df, aes(xintercept = hi, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
facet_wrap(~ student, ncol = 2, scales = "free_y") +
scale_linetype_manual(values = c("95% CI" = "dashed", "Mean" = "solid")) +
labs(x = expression(tau[ij]), y = "Count", linetype = "") +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
panel.grid = element_blank()
)
# histogram + vlines, 5x2 panels
ggplot(draws_df, aes(x = tau)) +
geom_histogram(
bins = 60,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(data = sum_df, aes(xintercept = mean, linetype = "Mean"),
linewidth = 1.0, color = "black") +
geom_vline(data = sum_df, aes(xintercept = lo, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
geom_vline(data = sum_df, aes(xintercept = hi, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
facet_wrap(~ student, ncol = 2, scales = "free_y") +
scale_linetype_manual(values = c("95% CI" = "dashed", "Mean" = "solid")) +
labs(x = expression(tau[ij]), y = "Count", linetype = "") +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
panel.grid = element_blank()
) +
scale_x_continuous(
breaks = scales::pretty_breaks(n = 8),   # automatic, more ticks
minor_breaks = scales::pretty_breaks(n = 16)
)
# histogram + vlines, 5x2 panels
ggplot(draws_df, aes(x = tau)) +
geom_histogram(
bins = 60,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(data = sum_df, aes(xintercept = mean, linetype = "Mean"),
linewidth = 1.0, color = "black") +
geom_vline(data = sum_df, aes(xintercept = lo, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
geom_vline(data = sum_df, aes(xintercept = hi, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
facet_wrap(~ student, ncol = 2, scales = "free_y") +
scale_linetype_manual(values = c("95% CI" = "dashed", "Mean" = "solid")) +
labs(x = expression(tau[ij]), y = "Count", linetype = "") +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
panel.grid = element_blank()
) +
scale_x_continuous(
breaks = seq(-30, 60, by = 5),
minor_breaks = seq(-2, 4, by = 0.25)
)
# histogram + vlines, 5x2 panels
ggplot(draws_df, aes(x = tau)) +
geom_histogram(
bins = 60,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(data = sum_df, aes(xintercept = mean, linetype = "Mean"),
linewidth = 1.0, color = "black") +
geom_vline(data = sum_df, aes(xintercept = lo, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
geom_vline(data = sum_df, aes(xintercept = hi, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
facet_wrap(~ student, ncol = 2, scales = "free_y") +
scale_linetype_manual(values = c("95% CI" = "dashed", "Mean" = "solid")) +
labs(x = expression(tau[ij]), y = "Count", linetype = "") +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
panel.grid = element_blank()
) +
scale_x_continuous(
breaks = seq(-60, 60, by = 10),
minor_breaks = seq(-2, 4, by = 0.25)
)
N
NJ
idx <- sample(10, 1:NJ, replace = FALSE)
Ni <- 10
idx <- sample(1:NJ, Ni, replace = FALSE)
# posterior draws of tau_ij (theta) for each selected student
draws_df <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- stan_data$Z[i, ]                          # length Kz
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
student = factor(paste0("i = ", i), levels = paste0("i = ", idx)),
tau = tau_draws
)
})
# mean + 95% equal-tail CI
sum_df <- draws_df %>%
group_by(student) %>%
summarise(
mean = mean(tau),
lo   = quantile(tau, 0.025),
hi   = quantile(tau, 0.975),
.groups = "drop"
)
# histogram + vlines, 5x2 panels
ggplot(draws_df, aes(x = tau)) +
geom_histogram(
bins = 60,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(data = sum_df, aes(xintercept = mean, linetype = "Mean"),
linewidth = 1.0, color = "black") +
geom_vline(data = sum_df, aes(xintercept = lo, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
geom_vline(data = sum_df, aes(xintercept = hi, linetype = "95% CI"),
linewidth = 0.8, color = "black") +
facet_wrap(~ student, ncol = 2, scales = "free_y") +
scale_linetype_manual(values = c("95% CI" = "dashed", "Mean" = "solid")) +
labs(x = expression(tau[ij]), y = "Count", linetype = "") +
theme_minimal(base_size = 12) +
theme(
legend.position = "bottom",
panel.grid = element_blank()
) +
scale_x_continuous(
breaks = seq(-60, 60, by = 10),
minor_breaks = seq(-2, 4, by = 0.25)
)
j_i
##### Table #####
# optional nice names (otherwise column numbers will be used)
z_names <- colnames(stan_data$Z); if (is.null(z_names)) z_names <- paste0("z", 1:ncol(stan_data$Z))
h_names <- colnames(stan_data$H); if (is.null(h_names)) h_names <- paste0("h", 1:ncol(stan_data$H))
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- as.numeric(stan_data$H[i, ])  # H is stored at N-level in your data
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble_row(setNames(as.list(z_i), z_names))) %>%
bind_cols(as_tibble_row(setNames(as.list(h_j), h_names)))
})
##### Table #####
library(purrr)
library(knitr)
library(kableExtra)
# optional nice names (otherwise column numbers will be used)
z_names <- colnames(stan_data$Z); if (is.null(z_names)) z_names <- paste0("z", 1:ncol(stan_data$Z))
h_names <- colnames(stan_data$H); if (is.null(h_names)) h_names <- paste0("h", 1:ncol(stan_data$H))
##### Table #####
library(purrr)
library(knitr)
library(kableExtra)
# optional nice names (otherwise column numbers will be used)
z_names <- colnames(stan_data$Z); if (is.null(z_names)) z_names <- paste0("z", 1:ncol(stan_data$Z))
h_names <- colnames(stan_data$H); if (is.null(h_names)) h_names <- paste0("h", 1:ncol(stan_data$H))
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- as.numeric(stan_data$H[i, ])  # H is stored at N-level in your data
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble_row(setNames(as.list(z_i), z_names))) %>%
bind_cols(as_tibble_row(setNames(as.list(h_j), h_names)))
})
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- as.numeric(stan_data$H[i, ])
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble(t(z_i), .name_repair = "minimal") %>% setNames(z_names)) %>%
bind_cols(as_tibble(t(h_j), .name_repair = "minimal") %>% setNames(h_names))
})
tab <- tab %>%
select(i, j, all_of(z_names), all_of(h_names), mean, lo, hi) %>%
mutate(across(c(mean, lo, hi), ~ round(.x, 3)))
z_names <- colnames(stan_data$Z)
if (is.null(z_names) || any(is.na(z_names)) || any(z_names == "")) z_names <- paste0("z", 1:Kz)
h_names <- colnames(stan_data$H)
if (is.null(h_names) || any(is.na(h_names)) || any(h_names == "")) h_names <- paste0("h", 1:Kh)
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- as.numeric(stan_data$H[i, ])
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble(t(z_i), .name_repair = "minimal") %>% setNames(z_names)) %>%
bind_cols(as_tibble(t(h_j), .name_repair = "minimal") %>% setNames(h_names))
})
tab <- tab %>%
select(i, j, starts_with("z"), starts_with("h"), mean, lo, hi) %>%
mutate(across(c(mean, lo, hi), ~ round(.x, 3)))
kable(tab,
format = "latex",
booktabs = TRUE,
caption = "Posterior summaries for $\\tau_{ij}$ with regressors $z_i$ and study features $h_{j_i}$.",
align = "r") %>%
kable_styling(latex_options = c("hold_position", "scale_down"))
tab
kable(tab,
format = "latex",
booktabs = TRUE,
caption = "Posterior summaries for $\\tau_{ij}$ with regressors $z_i$ and study features $h_{j_i}$.",
align = "r") %>%
kable_styling(latex_options = c("hold_position", "scale_down"))
Table <- kable(tab,
format = "latex",
booktabs = TRUE,
caption = "Posterior summaries for $\\tau_{ij}$ with regressors $z_i$ and study features $h_{j_i}$.",
align = "r") %>%
kable_styling(latex_options = c("hold_position", "scale_down"))
Table
latex_tab <- kable(
tab,
format = "latex",
booktabs = TRUE,
caption = "Posterior summaries for $\\tau_{ij}$ with regressors $z_i$ and study features $h_{j_i}$.",
align = "r"
) %>%
kable_styling(latex_options = c("hold_position", "scale_down"))
save_kable(latex_tab, file = "tau_ij_table.tex")
library(dplyr)
library(purrr)
library(tibble)
library(knitr)
library(kableExtra)
# safer default names if Z/H have empty colnames
z_names <- colnames(stan_data$Z)
if (is.null(z_names) || any(is.na(z_names)) || any(z_names == "")) z_names <- paste0("z", 1:Kz)
h_names <- colnames(stan_data$H)
if (is.null(h_names) || any(is.na(h_names)) || any(h_names == "")) h_names <- paste0("h", 1:Kh)
# drop z1 and h1 (and keep remaining order)
z_keep <- z_names[-1]
h_keep <- h_names[-1]
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- as.numeric(stan_data$H[i, ])
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble(t(z_i), .name_repair = "minimal") %>% setNames(z_names)) %>%
bind_cols(as_tibble(t(h_j), .name_repair = "minimal") %>% setNames(h_names))
})
tab <- tab %>%
select(i, j, all_of(z_keep), all_of(h_keep), mean, lo, hi) %>%   # preserves order
mutate(across(c(mean, lo, hi), ~ round(.x, 2)))                   # 2 decimals
latex_tab <- kable(
tab,
format = "latex",
booktabs = TRUE,
caption = "Posterior summaries for $\\tau_{ij}$ with regressors $z_i$ and study features $h_{j_i}$.",
align = "r"
) %>%
kable_styling(latex_options = c("hold_position", "scale_down"))
save_kable(latex_tab, file = "Tables/tau_ij_table.tex")
save_kable(latex_tab, file = "tau_ij_table.tex")
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- round(as.numeric(stan_data$H[i, ]), 2)
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble(t(z_i), .name_repair = "minimal") %>% setNames(z_names)) %>%
bind_cols(as_tibble(t(h_j), .name_repair = "minimal") %>% setNames(h_names))
})
tab <- tab %>%
select(i, j, all_of(z_keep), all_of(h_keep), mean, lo, hi) %>%   # preserves order
mutate(across(c(mean, lo, hi), ~ round(.x, 2)))                   # 2 decimals
library(dplyr)
library(purrr)
library(tibble)
library(knitr)
library(kableExtra)
# safer default names if Z/H have empty colnames
z_names <- colnames(stan_data$Z)
if (is.null(z_names) || any(is.na(z_names)) || any(z_names == "")) z_names <- paste0("z", 1:Kz)
h_names <- colnames(stan_data$H)
if (is.null(h_names) || any(is.na(h_names)) || any(h_names == "")) h_names <- paste0("h", 1:Kh)
# drop z1 and h1 (and keep remaining order)
z_keep <- z_names[-1]
h_keep <- h_names[-1]
tab <- map_dfr(idx, function(i){
j_i <- stan_data$id[i]
z_i <- as.numeric(stan_data$Z[i, ])
h_j <- round(as.numeric(stan_data$H[i, ]), 2)
tau_draws <- as.vector(post_delta[, j_i, ] %*% z_i)
tibble(
i = i,
j = j_i,
mean = mean(tau_draws),
lo   = quantile(tau_draws, 0.025),
hi   = quantile(tau_draws, 0.975)
) %>%
bind_cols(as_tibble(t(z_i), .name_repair = "minimal") %>% setNames(z_names)) %>%
bind_cols(as_tibble(t(h_j), .name_repair = "minimal") %>% setNames(h_names))
})
tab <- tab %>%
select(i, j, all_of(z_keep), all_of(h_keep), mean, lo, hi) %>%   # keep order
mutate(
across(
where(is.numeric) & !c(i, j),
~ round(.x, 2)
)
)
latex_tab <- kable(
tab,
format = "latex",
booktabs = TRUE,
caption = "Posterior summaries for $\\tau_{ij}$ with regressors $z_i$ and study features $h_{j_i}$.",
align = "r"
) %>%
kable_styling(latex_options = c("hold_position", "scale_down"))
save_kable(latex_tab, file = "tau_ij_table.tex")
