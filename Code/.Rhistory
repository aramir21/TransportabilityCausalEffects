linewidth = 1.0,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_low, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_high, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
facet_wrap(~ J, ncol = 2) +
scale_linetype_manual(
name = NULL,
values = c("True value" = "solid", "95% CI" = "dashed")
) +
coord_cartesian(xlim = x_lim, ylim = c(0, y_max)) +
labs(
# title = expression("Posterior draws of " * Sigma[22]),
x = expression(Sigma[22]),
y = "Count"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "bottom",
legend.box = "horizontal",
strip.background = element_blank(),
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold"),
axis.title = element_text(face = "plain")
)
# Plot theta
# --- posterior draws (delta[2,2]) ---
j <- 1 # Study
l <- 2 # Parameter
i <- 1 # Unit
post_delta40 <- draws40[["delta"]][,j,l]
load("PopValJ40.RData")
true_delta40 <- PopVal[["delta_true"]][j,l]
true_tau40 <- PopVal[["theta"]][i]
post_delta30 <- draws30[["delta"]][,j,l]
load("PopValJ30.RData")
true_delta30 <- PopVal[["delta_true"]][j,l]
true_tau30 <- PopVal[["theta"]][i]
post_delta20 <- draws20[["delta"]][,j,l]
load("PopValJ20.RData")
true_delta20 <- PopVal[["delta_true"]][j,l]
true_tau20 <- PopVal[["theta"]][i]
post_delta10 <- draws10[["delta"]][,j,l]
load("PopValJ10.RData")
true_delta10 <- PopVal[["delta_true"]][j,l]
true_tau10 <- PopVal[["theta"]][i]
# --- long df with panel-specific true values ---
df <- bind_rows(
tibble(value = post_delta40, J = "J = 40", true = true_delta40),
tibble(value = post_delta30, J = "J = 30", true = true_delta30),
tibble(value = post_delta20, J = "J = 20", true = true_delta20),
tibble(value = post_delta10, J = "J = 10", true = true_delta10)
) %>%
mutate(J = factor(J, levels = c("J = 40","J = 30","J = 20","J = 10")))
# 95% equal-tailed CI per panel
ci_df <- df %>%
group_by(J) %>%
summarise(
ci_low  = quantile(value, 0.025),
ci_high = quantile(value, 0.975),
true    = first(true),
.groups = "drop"
)
# consistent axes across panels
x_lim <- range(df$value, ci_df$true, ci_df$ci_low, ci_df$ci_high, na.rm = TRUE)
tmp_counts <- ggplot_build(
ggplot(df, aes(x = value)) +
geom_histogram(bins = 80, boundary = 0, closed = "left") +
facet_wrap(~ J, ncol = 2)
)$data[[1]]$count
y_max <- max(tmp_counts, na.rm = TRUE)
# ---- plot ----
ggplot(df, aes(x = value)) +
geom_histogram(
bins = 80,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(
data = ci_df,
aes(xintercept = true, linetype = "True value"),
linewidth = 1.0,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_low, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_high, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
facet_wrap(~ J, ncol = 2) +
scale_linetype_manual(
name = NULL,
values = c("True value" = "solid", "95% CI" = "dashed")
) +
coord_cartesian(xlim = x_lim, ylim = c(0, y_max)) +
labs(
# title = expression("Posterior draws of " * theta[j2]),
x = expression(theta[12]),
y = "Count"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "bottom",
legend.box = "horizontal",
strip.background = element_blank(),
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold"),
axis.title = element_text(face = "plain")
)
# Plot tau (treatment effect)
load("PopValJ40.RData")
true_tau40 <- PopVal[["theta"]][i]
post_delta40 <- draws40[["delta"]][,j,]
Z40 <- c(1, PopVal[["X"]][i,1])
tau40 <- post_delta40 %*% Z40
load("PopValJ30.RData")
true_tau30 <- PopVal[["theta"]][i]
post_delta30 <- draws30[["delta"]][,j,]
Z30 <- c(1, PopVal[["X"]][i,1])
tau30 <- post_delta30 %*% Z30
load("PopValJ20.RData")
true_tau20 <- PopVal[["theta"]][i]
post_delta20 <- draws20[["delta"]][,j,]
Z20 <- c(1, PopVal[["X"]][i,1])
tau20 <- post_delta20 %*% Z20
load("PopValJ10.RData")
true_tau10 <- PopVal[["theta"]][i]
post_delta10 <- draws10[["delta"]][,j,]
Z10 <- c(1, PopVal[["X"]][i,1])
tau10 <- post_delta10 %*% Z10
# --- long df (panel-specific true values) ---
df <- bind_rows(
tibble(value = tau40, J = "J = 40", true = true_tau40),
tibble(value = tau30, J = "J = 30", true = true_tau30),
tibble(value = tau20, J = "J = 20", true = true_tau20),
tibble(value = tau10, J = "J = 10", true = true_tau10)
) %>%
mutate(J = factor(J, levels = c("J = 40","J = 30","J = 20","J = 10")))
# 95% equal-tailed CI per panel
ci_df <- df %>%
group_by(J) %>%
summarise(
ci_low  = quantile(value, 0.025),
ci_high = quantile(value, 0.975),
true    = first(true),
.groups = "drop"
)
# consistent axes across panels
x_lim <- range(df$value, ci_df$true, ci_df$ci_low, ci_df$ci_high, na.rm = TRUE)
tmp_counts <- ggplot_build(
ggplot(df, aes(x = value)) +
geom_histogram(bins = 80, boundary = 0, closed = "left") +
facet_wrap(~ J, ncol = 2)
)$data[[1]]$count
y_max <- max(tmp_counts, na.rm = TRUE)
# ---- plot ----
ggplot(df, aes(x = value)) +
geom_histogram(
bins = 80,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(
data = ci_df,
aes(xintercept = true, linetype = "True value"),
linewidth = 1.0,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_low, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_high, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
facet_wrap(~ J, ncol = 2) +
scale_linetype_manual(
name = NULL,
values = c("True value" = "solid", "95% CI" = "dashed")
) +
coord_cartesian(xlim = x_lim, ylim = c(0, y_max)) +
labs(
# title = bquote("Posterior draws of " * tau[.(i) * "," * .(j)]),
x = bquote(tau[.(i) * "" * .(j)]),
y = "Count"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "bottom",
legend.box = "horizontal",
strip.background = element_blank(),
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold"),
axis.title = element_text(face = "plain")
)
library(e1071)
skewness(tau40)
skewness(tau30)
skewness(tau20)
skewness(tau10)
#### Prediction ####
x10 <- rnorm(1, 0, 1)
w10 <- rnorm(1, 0, 1); w20 <- rnorm(1, 0, 1)
Pred_tau <- function(x10, w10, w20, Gammas, Sigmas){
# Gammas <- draws10[["Psi"]][1,,]
# Sigmas <- draws10[["Sigma_delta"]][1,,]
zij0 <- c(1, x10)
hj0 <- c(1, w10, w20)
mean_theta <- t(Gammas)%*%hj0
thetaj0 <- MASS::mvrnorm(1, mu = mean_theta, Sigmas)
tauj0 <-  zij0%*%thetaj0
return(tauj0)
}
Kw <- 3
Psi_true  <- matrix(c( 0.8,  0.2,
0.3,  0.4,
0.1, 0.5),
nrow = Kw, byrow = TRUE)
Sigma_delta_true <- matrix(c(0.15, 0.02,
0.02, 0.10), 2, 2)
true_tauij0 <- Pred_tau(x10, w10, w20, Gammas = Psi_true, Sigmas = Sigma_delta_true)
S <- 1000
taui0j040 <- sapply(1:S, function(s) {Pred_tau(x10, w10, w20, Gammas = draws40[["Psi"]][s,,],
Sigmas = draws40[["Sigma_delta"]][s,,])})
taui0j030 <- sapply(1:S, function(s) {Pred_tau(x10, w10, w20, Gammas = draws30[["Psi"]][s,,],
Sigmas = draws30[["Sigma_delta"]][s,,])})
taui0j020 <- sapply(1:S, function(s) {Pred_tau(x10, w10, w20, Gammas = draws20[["Psi"]][s,,],
Sigmas = draws20[["Sigma_delta"]][s,,])})
taui0j010 <- sapply(1:S, function(s) {Pred_tau(x10, w10, w20, Gammas = draws10[["Psi"]][s,,],
Sigmas = draws10[["Sigma_delta"]][s,,])})
# --- long df (panel-specific true values) ---
df <- bind_rows(
tibble(value = taui0j040, J = "J = 40", true = true_tauij0),
tibble(value = taui0j030, J = "J = 30", true = true_tauij0),
tibble(value = taui0j020, J = "J = 20", true = true_tauij0),
tibble(value = taui0j010, J = "J = 10", true = true_tauij0)
) %>%
mutate(J = factor(J, levels = c("J = 40","J = 30","J = 20","J = 10")))
# 95% equal-tailed CI per panel
ci_df <- df %>%
group_by(J) %>%
summarise(
ci_low  = quantile(value, 0.025),
ci_high = quantile(value, 0.975),
true    = first(true),
.groups = "drop"
)
# consistent axes across panels
x_lim <- range(df$value, ci_df$true, ci_df$ci_low, ci_df$ci_high, na.rm = TRUE)
tmp_counts <- ggplot_build(
ggplot(df, aes(x = value)) +
geom_histogram(bins = 80, boundary = 0, closed = "left") +
facet_wrap(~ J, ncol = 2)
)$data[[1]]$count
y_max <- max(tmp_counts, na.rm = TRUE)
# ---- plot ----
ggplot(df, aes(x = value)) +
geom_histogram(
bins = 80,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(
data = ci_df,
aes(xintercept = true, linetype = "True value"),
linewidth = 1.0,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_low, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_high, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
facet_wrap(~ J, ncol = 2) +
scale_linetype_manual(
name = NULL,
values = c("True value" = "solid", "95% CI" = "dashed")
) +
coord_cartesian(xlim = x_lim, ylim = c(0, y_max)) +
labs(
# title = bquote("Posterior draws of " * tau[.(i) * "," * .(j)]),
x = bquote(tau[.(i) * "" * .(j)]),
y = "Count"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "bottom",
legend.box = "horizontal",
strip.background = element_blank(),
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold"),
axis.title = element_text(face = "plain")
)
# ---- plot ----
ggplot(df, aes(x = value)) +
geom_histogram(
bins = 80,
boundary = 0,
closed = "left",
fill = "grey85",
color = "white",
linewidth = 0.25
) +
geom_vline(
data = ci_df,
aes(xintercept = true, linetype = "True value"),
linewidth = 1.0,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_low, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
geom_vline(
data = ci_df,
aes(xintercept = ci_high, linetype = "95% CI"),
linewidth = 0.8,
color = "black"
) +
facet_wrap(~ J, ncol = 2) +
scale_linetype_manual(
name = NULL,
values = c("True value" = "solid", "95% CI" = "dashed")
) +
coord_cartesian(xlim = x_lim, ylim = c(0, y_max)) +
labs(
# title = bquote("Posterior draws of " * tau[.(i) * "," * .(j)]),
x = bquote(tau[0]),
y = "Count"
) +
theme_classic(base_size = 13) +
theme(
legend.position = "bottom",
legend.box = "horizontal",
strip.background = element_blank(),
strip.text = element_text(face = "bold"),
plot.title = element_text(face = "bold"),
axis.title = element_text(face = "plain")
)
ci_df$ci_high-ci_df$ci_low
A <- matrix(c(1/3, 0,
0,   1/2), 2, 2)
x <- seq(-4, 4, length = 200)
y <- seq(-4, 4, length = 200)
grid <- expand.grid(x, y)
z <- apply(grid, 1, function(v) t(v) %*% A %*% v)
z <- matrix(z, length(x), length(y))
contour(x, y, z,
levels = c(0.5, 1, 2, 4, 8),
xlab = "Intercept direction",
ylab = "Covariate direction")
points(0, 0, pch = 19, col = "red")  # mean of H
points(0, 3, pch = 19, col = "blue") # extrapolation
eigen(A)
points(3, 0, pch = 19, col = "green") # extrapolation
set.seed(10101)
# --- Basic structure ---
J  <- 40 # 40, 30, 20, 10 number of studies
l <- 8 # 8, 6, 4, 2
N  <- c(rep(500, l), rep(256, l), rep(145, l), rep(760, l), rep(678, l)) # sample sizes per study
NJ <- sum(N)
study_id <- unlist(lapply(1:J, function(j) rep(j, N[j])))
# Individual-level X
x1 <- rnorm(NJ)
x2 <- rnorm(NJ)
x3 <- rnorm(NJ)
X  <- cbind(x1, x2, x3)                    # Kx = 3
Kx <- ncol(X)
# Z for heterogeneous treatment effect: intercept + x1 only
Z  <- cbind(1, x1)                         # Kz = 2
Kz <- ncol(Z)
# Study-level covariates W_j   (Kw = 3 here)
Kw <- 3
W_study <- matrix(NA, nrow = J, ncol = Kw)
for (j in 1:J) {
W_study[j, ] <- c(1, rnorm(Kw - 1, mean = j, sd = 1))
}
# Expand W to individual level (so we can store it in Data)
W_full <- W_study[study_id, ]              # NJ x Kw
### Data for second example in the paper ###
HtH_inv <- solve(t(W_study)%*%W_study)
HtH_inv
eigen(HtH_inv)
hj0 <- c(1, 0, 0)
t(hj0)%*%HtH_inv%*%hj0
hj0 <- c(0, 1, 0)
t(hj0)%*%HtH_inv%*%hj0
hj0 <- c(0, 0, 1)
t(hj0)%*%HtH_inv%*%hj0
Sigma_delta_true <- matrix(c(0.15, 0.02,
0.02, 0.10), 2, 2)
eigen(HtH_inv)
eigen(HtH_inv)
hj0 <- c(1, 0, 0)
t(hj0)%*%HtH_inv%*%hj0
hj0 <- c(0, 1, 0)
t(hj0)%*%HtH_inv%*%hj0
hj0 <- c(0, 0, 1)
t(hj0)%*%HtH_inv%*%hj0
eigen(Sigma_delta_true)
t(zij0)%*%Sigma_delta_true%*%zij0
zij0 <- c(1, 0)
t(zij0)%*%Sigma_delta_true%*%zij0
zij0 <- c(0, 1)
t(zij0)%*%Sigma_delta_true%*%zij0
rm(list = ls())
set.seed(10101)
# --- Basic structure ---
J  <- 40 # 40, 30, 20, 10 number of studies
l <- 8 # 8, 6, 4, 2
N  <- c(rep(500, l), rep(256, l), rep(145, l), rep(760, l), rep(678, l)) # sample sizes per study
NJ <- sum(N)
study_id <- unlist(lapply(1:J, function(j) rep(j, N[j])))
# Individual-level X
x1 <- rnorm(NJ)
x2 <- rnorm(NJ)
x3 <- rnorm(NJ)
X  <- cbind(x1, x2, x3)                    # Kx = 3
Kx <- ncol(X)
# Z for heterogeneous treatment effect: intercept + x1 only
Z  <- cbind(1, x1)                         # Kz = 2
Kz <- ncol(Z)
# Study-level covariates W_j   (Kw = 3 here)
Kw <- 3
W_study <- matrix(NA, nrow = J, ncol = Kw)
for (j in 1:J) {
W_study[j, ] <- c(1, rnorm(Kw - 1, mean = j, sd = 1))
}
# Expand W to individual level (so we can store it in Data)
W_full <- W_study[study_id, ]              # NJ x Kw
# Treatment assignment
Tr <- rbinom(NJ, 1, 0.3)
# --- True hierarchical parameters ---
beta_true  <- c(0.5, 0.2, 0.3)           # baseline effect of X
gamma_true <- c(0.4, 0.1, 0.2)           # baseline effect of W on y
# Psi: Kw x Kz mapping W_j -> mean(delta_j)
Psi_true  <- matrix(c( 0.8,  0.2,
0.3,  0.4,
0.1, 0.5),
nrow = Kw, byrow = TRUE)
Sigma_delta_true <- matrix(c(0.15, 0.02,
0.02, 0.10), 2, 2)
sigma_true <- 0.5
# --- Draw study-specific deltas and generate data ---
delta_true <- matrix(NA, nrow = J, ncol = Kz)
theta      <- numeric(NJ)
library(MASS)
start <- 1
for (j in 1:J) {
N_j <- N[j]
ind <- start:(start + N_j - 1)
# mean(delta_j | W_j)
mean_delta_j <- W_study[j, ] %*% Psi_true   # 1 x Kz
delta_j      <- MASS::mvrnorm(1, mean_delta_j, Sigma_delta_true)
delta_true[j, ] <- delta_j
theta[ind] <- Z[ind, ] %*% delta_j          # theta_ij
start <- start + N_j
}
# Outcome: includes X*beta and W*gamma
e  <- rnorm(NJ, 0, sigma_true)
y  <- Tr * theta + X %*% beta_true + W_full %*% gamma_true + e
# Put everything in a data.frame including w's
Data <- data.frame(
id = study_id,
y  = as.numeric(y),
x1 = x1, x2 = x2, x3 = x3,
w1 = W_full[, 1],
w2 = W_full[, 2],
w3 = W_full[, 3],
Tr = Tr
)
View(Data)
